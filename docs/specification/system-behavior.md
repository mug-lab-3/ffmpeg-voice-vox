# System Behavior Specification

本ソフトウェアのシステム全体の動作仕様、自動監視、および生成ファイルの管理について記載します。

## 1. 動作環境・要件
- **OS**: Windows / macOS
- **Runtime**: Python 3.10以降
- **依存サービス**:
    - **Voicevox**: ローカルホスト (`127.0.0.1`) のポート `50021` で稼働している必要があります。

## 2. サーバー起動・管理 (Process Management)

### 2.1 二重起動防止 (Single Instance)
起動時に同一プロジェクトのプロセスが既に実行されているかスキャンし、存在する場合は古いプロセスを自動的に終了（Kill）します。これにより、ポート競合やDBロックを防ぎます。

### 2.2 空きポートの自動検索
設定されたポート（デフォルト3000）が既に使用されている場合、空いているポートを自動的に検索して起動します。

### 2.3 自動監視・シャットダウン (Watchdog)
リソース節約のため、最後のアクティビティ（APIアクセス等）から **900秒 (15分)** 経過するとプロセスを安全に自動終了します。
- **実装**: `run.py` 内の `shutdown_manager`。

### 2.4 自動リロード機能
サーバーが再起動（または意図せず切断）されたことを検知すると、フロントエンド（WebUI）は最新の状態を反映するために自動的にページをリロードします。

## 3. データベース仕様 (Optimization)

### 3.1 SSD寿命の保護と高速化
SQLiteの標準的なファイル書き込みを最小限に抑えるため、以下の最適化を適用しています。
- **Journal Mode**: `MEMORY` (ジャーナルファイルをメモリ上に保持)
- **Synchronous**: `OFF` (OSの書き込み完了を待機しない)
- **Temp Store**: `MEMORY` (一時ファイルをメモリ上に保持)
これにより、SSDへの不要な書き込みを減らし、応答速度を向上させています。

### 3.2 構成
- **場所**: 出力ディレクトリ内の `transcriptions.db`。

## 4. 生成ファイル仕様

### 4.1 ファイル命名規則
`{ID}_{SHA1}_{テキスト先頭}.wav`
- 例: `102_a1b2c3d4_こんにちは.wav`
- **SHA1ハッシュ**: テキスト内容に基づくハッシュを含めることで、編集後の再生成時にブラウザのキャッシュ問題を回避し、内容の不整合を確実に防ぎます。

## 5. WebUI タブ管理

ブラウザの接続制限（6本制限）を回避し、リソース競合を防ぐための仕組み：
- **SharedWorker**: 複数タブ間で単一の SSE コネクションを共有。
- **重複防止**: `BroadcastChannel` を使用し、新しいタブが開かれた際に古いタブを自動切断または警告表示します。

## 6. ネイティブ連携

### 6.1 高DPI対応ダイアログ
設定画面でのディレクトリ・ファイル選択にはOS標準のダイアログを使用します。Windows環境では `ctypes` を使用し、高DPI（スケーリング）環境でもぼやけない鮮明な表示を行います。

### 6.2 履歴の編集と無効化 (Invalidation)
WebUIからログを編集すると、既存の音声ファイルは即座に物理削除され、ステータスは「pending」に戻ります。再生成されるまで不整合なデータが残ることはありません。
