# User Configuration Specification

本ソフトウェアの設定管理システムについて記載します。

## 概要

設定管理は、柔軟性と堅牢性の両立を目的としています。
ユーザーが設定を変更できる `config.json` と、システムが提供する標準値である `default_config.json` の2段構えで構成されています。

## 設定ファイルの構成

### 1. config.json
ユーザー定義の設定ファイルです。`data/config.json` に保存されます。
このファイルが存在しない場合、または一部の項目が不足・不正な場合は、Pydantic スキーマで定義されたデフォルト値が反映されます。
以前使用されていた `default_config.json` は廃止され、初期値はコード内のスキーマ定義に集約されました。

## 同期・バリデーションロジック (Pydantic)

サーバー起動時に以下のプロセスが実行されます。

1. **読み込み**: `config.json` を読み込みます。
2. **バリデーションと補完 (Pydantic)**:
    - **スキーマ検証**: [Pydantic](https://docs.pydantic.dev/) モデルを使用して、型チェックと構造チェックを同時に行います。
    - **デフォルト補完**: `config.json` に項目が存在しない場合、モデルで定義されたデフォルト値が自動的に補完されます。
    - **カスタムバリデーション**:
        - `output_dir`: ディレクトリが存在するかチェックし、存在しない場合は警告を表示します（設定自体は維持されます）。
        - `ffmpeg_path`: パスが存在するかチェックし、存在しない場合は警告を表示します。
3. **自己修復と堅牢化**:
    - **ファイル破損対策**: `config.json` の読み込み時に JSON 構文エラー（破損）を検出した場合、自動的に `.corrupt.[timestamp]` というファイル名でバックアップを作成し、一時的にデフォルト設定で起動します。これにより、設定ファイルの破損による起動不能やデータ消失（意図しない上書き）を防ぎます。
    - **読み込みエラーの局所化**: 設定の一部が無効（例: 範囲外の数値）であっても、セクション全体を破棄せず、**無効なフィールドのみ**をデフォルト値に戻し、他の有効な設定は維持します（ベストエフォート読み込み）。
    - 補正が行われた場合、最新の設定内容が即座に `config.json` に書き戻されます。

## 詳細設定仕様 (詳細バリデーション)

各設定項目の型、デフォルト値、およびバリデーションの内容は以下の通りです。Pydantic スキーマによって厳密に管理されています。

### 1. `server` (サーバー設定)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `host` | string | `127.0.0.1` | 文字列形式チェック |

### 2. `voicevox` (VoiceVox 接続設定)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `host` | string | `127.0.0.1` | 文字列形式チェック |
| `port` | integer | `50021` | 数値型チェック |

### 3. `synthesis` (音声合成パラメータ)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `speaker_id` | integer | `1` | 数値型チェック, **0以上** |
| `speed_scale` | float | `1.0` | 浮動小数点数チェック, **0.5 〜 1.5** |
| `pitch_scale` | float | `0.0` | 浮動小数点数チェック, **-0.15 〜 0.15** |
| `intonation_scale` | float | `1.0` | 浮動小数点数チェック, **0.0 〜 2.0** |
| `volume_scale` | float | `1.0` | 浮動小数点数チェック, **0.0 〜 2.0** |

### 4. `system` (システム設定)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `output_dir` | string | `""` | **実在チェック**: 存在しない場合ログに警告を表示（設定は維持） |

### 5. `ffmpeg` (FFmpeg・マイク設定)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `ffmpeg_path` | string | `""` | **実在チェック**: 存在しない場合ログに警告を表示（設定は維持） |
| `input_device` | string | `""` | 文字列形式チェック |
| `model_path` | string | `""` | 文字列形式チェック |
| `vad_model_path` | string | `""` | 文字列形式チェック |
| `host` | string | `127.0.0.1` | **形式チェック**: 有効なIPアドレスまたはホスト名でない場合はエラー（空文字禁止） |
| `queue_length` | integer | `10` | 数値型チェック, **1 〜 30**（範囲外または `null` はデフォルト `10` に補正） |

### 6. `resolve` (DaVinci Resolve 連携)
| 項目 | 型 | デフォルト | バリデーション |
| :--- | :--- | :--- | :--- |
| `enabled` | boolean | `false` | 真偽値チェック |
| `audio_track_index` | integer | `1` | 数値型チェック, **1 〜 50** |
| `video_track_index` | integer | `2` | 数値型チェック, **1 〜 50** |
| `target_bin` | string | `VoiceVox Captions` | インポート先ビン名（"root" はメディアプール直下） |
| `template_name` | string | `Auto` | 使用する Text+ テンプレート名 |

## 補足事項

- **型変換**: Pydantic は可能な限り自動的な型変換を試みます（例: 数値が期待される場所に `"123"` という文字列があれば、整数 `123` に変換します）。
- **型変換**: Pydantic は可能な限り自動的な型変換を試みます（例: 数値が期待される場所に `"123"` という文字列があれば、整数 `123` に変換します）。
- **フォールバック**: 型変換が不可能、または不適切な値が指定された場合、**各フィールド単位**で安全にデフォルト値へフォールバックされます（以前のセクション単位のリセット動作は廃止されました）。
- **実行時状態**: `is_synthesis_enabled` は実行時の状態であるため、本設定ファイルには含まれず、メモリ上で管理されます。
