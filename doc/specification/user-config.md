# User Configuration Specification

本ソフトウェアの設定管理システムについて記載します。

## 概要

設定管理は、柔軟性と堅牢性の両立を目的としています。
ユーザーが設定を変更できる `config.json` と、システムが提供する標準値である `default_config.json` の2段構えで構成されています。

## 設定ファイルの構成

### 1. default_config.json
システムのデフォルト値を定義するマスターファイルです。
サーバー起動時に参照され、全ての項目の型と初期値を保持します。

### 2. config.json
ユーザー定義の設定ファイルです。
このファイルが存在しない場合、または一部の項目が不足・不正な場合は、`default_config.json` の値が反映されます。

## 同期・バリデーションロジック

サーバー起動時に以下のプロセスが実行されます。

1. **読み込み**: `config.json` を読み込みます。
2. **マージ**: `default_config.json` をベースに、`config.json` の内容を上書きマージします。
3. **バリデーション**:
    - **型チェック**: 設定値の型がデフォルト値と異なる場合、デフォルト値に強制的に戻されます。（数値型が期待される場所に文字列がある場合などは、可能な限り変換を試みます）
    - **空文字チェック**: `template_bin` や `template_name` などの重要な項目が空、または空白のみの場合、デフォルト値に戻されます。
4. **自己修復**: 上記のプロセスで設定値が補正された場合、その内容は即座に `config.json` に書き戻され、ファイルが最新かつ正常な状態に保たれます。

## 主な設定カテゴリ

| カテゴリ | 説明 |
| :--- | :--- |
| `server` | サーバーのホスト設定 |
| `voicevox` | VoiceVox Engine への接続設定 |
| `synthesis` | 音声合成のパラメータ（話者、速度、ピッチなど） |
| `system` | 音声合成の有効化状態や出力ディレクトリ |
| `ffmpeg` | FFmpeg のパスやマイク入力、モデルのパス、キューの長さ |
| `resolve` | DaVinci Resolve 連携設定（トラック番号、テンプレート名） |

## 補足事項

- **フォールバック**: `default_config.json` が物理的に削除された場合でも、コード内にハードコードされた最終的なフォールバック値が使用されます。
- **WebUI 連携**: WebUI からの設定変更もこのバリデーションルールの対象となり、無効な値の保存が防止されます。
