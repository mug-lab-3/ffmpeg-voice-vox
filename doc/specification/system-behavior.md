# System Behavior Specification

本ソフトウェアのシステム全体の動作仕様、自動監視、および生成ファイルの管理について記載します。

## 1. 動作環境・要件
- **OS**: Windows 10/11 (推奨)
- **Runtime**: Python 3.10以降
- **依存サービス**:
    - **Voicevox**: ローカルホスト (`127.0.0.1`) のポート `50021` で稼働している必要があります。

## 2. 自動監視・シャットダウン (Watchdog)

リソースの節約を目的として、無操作時の自動終了機能を備えています。

- **仕組み**: 最後のアクティビティ（APIリクエスト、音声合成処理等）からの経過時間を監視します。
- **タイムアウト**: **300秒 (5分)**
- **挙動**: 5分間アクセスがない場合、プロセスを安全に終了します。
- **実装箇所**: `voicevox_controller.py` 内の `monitor_activity` スレッド。

## 3. 生成ファイル仕様

音声合成が行われると、設定された出力ディレクトリ（デフォルトは `val_output/` 等）に以下のファイルが生成されます。

### 3.1 ファイル命名規則
`{DB_ID}_{テキスト先頭5文字}.{拡張子}`
- 例: `12_こんにちは.wav`
- **注意**: ファイル名はDBのIDに紐付いて管理されており、同一IDでの再生成時には上書きまたは旧ファイルの削除が行われます。

### 3.2 構成内容
1.  **WAVファイル**: Voicevoxによって生成された音声データ。
2.  **SRTファイル**: 字幕データ (音声と同一ディレクトリに生成)。

## 4. 履歴の編集と無効化 (Invalidation)

WebUIから生成済みのログテキストを編集した場合、以下の処理が行われます。

- **DB更新**: 指定されたレコードの `text` カラムが更新されます。
- **音声の無効化**:
    - 紐付いていた既存のWAV/SRTファイルは物理的に削除されます。
    - DB上の `audio_duration` は `0.0` にリセットされ、`output_path` は `NULL` になります。
- **UI表示**: WebUI上では「生成未完了 (pending)」状態へと戻り、再生ボタンが赤色になります。
- **再生成**: 赤い再生ボタンをクリックするか、Resolveへの挿入（自動合成）を行うことで、新しいテキストに基づいた音声が再生成されます。

## 5. ログ・監視
- **アプリケーションログ**: `logs/app.log` に出力されます。
- **ログの構成**: 動作ログ、設定の同期情報、およびエラー時のスタックトレースが記録されます。
- **ローテーション**: ファイルサイズが1MBを超えると自動的にリネームされ、最大10世代まで保持されます。
