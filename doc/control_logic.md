# 制御内容 (Control Logic)

本システムの内部制御ロジック、特にストリーム処理と音声合成フローについて解説します。

## 1. メイン処理フロー (受信〜合成)

`server.py` の `whisper_receiver` 関数がエントリーポイントとなります。

1.  **ストリーム受信**:
    *   `POST /` に対してデータがチャンク形式で送られてくると、サーバーはバッファ(`buffer`)にデータを蓄積します。
    *   デリミタ（`}`）を検出するたびに、そこまでを1つのJSONオブジェクトとみなして切り出します。

2.  **JSON解析 (Parsing)**:
    *   切り出した文字列を `json.loads` でパースします。
    *   必須キー (`text`, `start`, `end`) が存在するかチェックします。キーが不足している場合はスキップします。

3.  **合成判定 (Switching)**:
    *   グローバル変数 `is_synthesis_enabled` を確認します。
    *   **ONの場合**: Voicevox連携処理に進みます。
    *   **OFFの場合**: ログに "Synthesis Skipped" を出力し、合成を行わずにデータを破棄します。

4.  **Voicevox連携＆保存**:
    *   **Audio Query**: 現在の設定(`current_config`)とテキストをエンドポイント `/audio_query` に送信し、合成パラメータを取得します。
    *   **Synthesis**: パラメータを `/synthesis` に送信し、WAVデータをバイナリで受け取ります。
    *   **保存**: `output/` フォルダに WAVファイルとSRTファイルを保存します。ファイル名は入力のタイムスタンプとテキストに基づいて一意に生成されます。

5.  **ログ更新**:
    *   処理結果（成功時のファイル名、所要時間など）をインメモリのログリスト(`received_logs`)に追加します。古いログは50件を超えると削除されます。

## 2. 状態管理 (State Management)

### 2.1 音声合成スイッチ
*   Web UIの「START/STOP」ボタンにより `is_synthesis_enabled` フラグが切り替わります。
*   このフラグはメモリ上に保持され、サーバー再起動でリセット(デフォルトON)されます。

### 2.2 再生管理 (Playback)
*   **排他制御**: 複数のブラウザや再生リクエストが競合しないよう、`playback_lock` (Threading Lock) を使用して再生状態(`playback_status`)を管理しています。
*   **非同期実行**: 再生処理(`winsound.PlaySound`)はブロッキング操作であるため、別スレッドで実行されます。これにより再生中もAPIのレスポンスがブロックされません。

## 3. 自動監視 (Watchdog)
*   別スレッドで `monitor_activity` 関数が常時稼働しています。
*   `last_activity_time` 変数を最後のリクエスト時刻で更新し続け、**300秒(5分)** 以上更新がない場合、`os._exit(0)` を呼び出しプロセスを強制終了します。

## 4. エラーハンドリング
*   **JSONデコードエラー**: 分割されたチャンクが不正なJSONの場合、そのブロックは破棄されますがサーバーは停止しません。
*   **Voicevox接続エラー**: Voicevoxが起動していない場合などは例外をキャッチし、サーバーのクラッシュを防ぎます。
