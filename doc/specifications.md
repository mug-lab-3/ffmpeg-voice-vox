# 仕様書 (Specifications)

## 1. 動作環境・要件
*   **OS**: Windows (推奨)
*   **Runtime**: Python 3.x
*   **依存サービス**:
    *   **Voicevox**: ローカルホスト (`127.0.0.1`) のポート `50021` で稼働している必要があります。

## 2. 起動と設定
*   **起動方法**: python `run.py` を実行してください。
*   **設定管理 (`config.json`)**:
    *   初回起動時に自動生成されます。
    *   ポート番号やVoicevoxの接続先、デフォルトの話者設定などを変更可能です。
    *   **設定項目**:
        *   `server`: Webサーバーの設定 (host, port)
        *   `voicevox`: Voicevoxエンジンの接続先 (host, port)
        *   `synthesis`: 音声合成のデフォルトパラメータ (speaker_id, speed, pitch, etc.)

## 3. インターフェース仕様

### 3.1 入力インターフェース (受信)
Whisperサーバー等の外部ソースからのストリーム入力を受け付けます。

*   **Endpoint**: `POST /`
*   **Method**: Stream Processing
*   **Input Format (JSON)**:
    受信データは以下のJSONオブジェクトが連続したストリームであることを期待します。
    ```json
    {
      "text": "認識されたテキスト",
      "start": 1000,   // 開始時間 (ミリ秒)
      "end": 2500      // 終了時間 (ミリ秒)
    }
    ```

### 3.2 フロントエンド API
Web UIとの通信に使用するREST APIです。

*   **設定管理 (`/api/config`)**
    *   `GET`: 現在の合成設定を取得。
    *   `POST`: 設定を更新。
    *   内部的には `config.json` の値（メモリキャッシュ）を更新します。

*   **ログ取得 (`/api/logs`)**
    *   `GET`: 最近の処理ログ（最大50件）を取得。

*   **制御系 API (`/api/control/*`)**
    *   `/api/control/state` (GET/POST): 自動合成機能のON/OFF切り替え。
    *   `/api/control/play` (POST): 指定されたファイル名の音声ファイルを再生。
    *   `/api/control/delete` (POST): 指定された音声ファイルとSRTファイルを削除。

## 4. 出力ファイル仕様
音声合成が成功すると `output/` フォルダに以下のファイルが生成されます。

### 4.1 ファイル命名規則
`{開始時間(ms)}_{話者名}_{テキスト先頭8文字}.{拡張子}`
*   例: `001500_ずんだもん_こんにちは.wav`

### 4.2 生成ファイル
1.  **WAVファイル**: Voicevoxによって生成された音声データ。
2.  **SRTファイル**: 字幕データ。
    *   開始時刻: `00:00:00,000` 固定
    *   終了時刻: 音声の長さに合わせて自動設定

## 5. ログ・監視
*   **アプリケーションログ**: `logs/app.log` に出力されます。
*   **自動シャットダウン**: サーバーは最後のアクティビティから **5分間 (300秒)** アクセスがない場合、自動的に終了します。
