# FFmpeg Voicevox Integration

マイク入力をリアルタイムで文字起こしし、VOICEVOXによる音声合成と動画編集ソフト（DaVinci Resolve）への素材挿入を効率化するための支援ツールです。
動画編集における「声入れ」と「字幕入れ」の作業を、シームレスなワークフローで劇的に加速させます。

## 基本フロー

本アプリは、マイクからの音声入力をきっかけとし、文字起こし、音声合成、動画編集ソフトへの取り込みまでを一貫して管理します。

```mermaid
graph TD
    A[マイク入力] --> B[FFmpeg / Whisper]
    B -->|文字起こし結果| C[本アプリ Web UI]
    C -->|テキスト送信| D[VOICEVOX]
    D -->|合成音声生成| C
    C -->|挿入ボタン押下| E[DaVinci Resolve]
    
    C -.->|テキスト修正 & 再生成| C
```

### 各コンポーネントの役割

*   **FFmpeg (Whisper フィルター内蔵)**: 音声のキャプチャ、および Whisper による高精度なリアルタイム文字起こしを担当します。
*   **VOICEVOX**: 確定したテキスト（または修正後のテキスト）から、豊かな表情を持つ合成音声を生成します。
*   **DaVinci Resolve**: 最終的な動画制作の場です。本アプリで生成された音声ファイルと字幕テキストは、挿入ボタンをクリックすることでタイムラインの指定位置へ配置されます。

### 本アプリの役割（司令塔）

本アプリは、これら強力な外部ツールを繋ぐ「ハブ」として機能します。

*   **オーケストレーション**: 音声認識から合成、編集ソフトへの橋渡しまでの一連のプロセスを効率化します。
*   **柔軟な修正ループ**: 文字起こしの誤認識があった場合でも、**UI上でテキストを修正して即座に音声を再生成・挿入**できる環境を提供します。
*   **資産管理**: 過去の生成履歴をデータベース化。過去のフレーズの再利用や、後からの微調整を容易にします。

## WebUI 管理画面

![WebUI Capture](docs/images/webui.png)

## 主な機能

### 🎯 ユーザー体験 (User Experience)
*   **シームレスな編集ループ**: 文字起こしの誤認識をWeb UI上で即座に修正し、ワンクリックで音声を再生成・DaVinci Resolveへ挿入（更新）できます。
*   **高解像度対応 (High DPI)**: Windows環境ではOSネイティブなダイアログを採用。高DPIディスプレイでもぼやけない、鮮明でモダンな操作感を提供します。
*   **ブラウザ自動管理**: `SharedWorker` 採用により、複数タブを開いても負荷を最小限に。サーバー再起動時の自動リロードや、重複タブの自動クリーンアップも備えています。

### ⚙️ 高度な自動化・効率化 (Automation)
*   **インテリジェント・スタートアップ**: 
    *   **二重起動防止**: 古いプロセスを自動検知してクリーンアップ。DBロックやポート競合を未然に防ぎます。
    *   **ポート自動検索**: 使用中のポートを自動回避し、常に安定した起動を保証します。
*   **オート・シャットダウン (Eco-friendly)**: 快適な作業後、一定時間アクティビティがない場合にリソースを節約するため、システムを自動的に安全終了します。

### 💾 信頼性とパフォーマンス (Reliability & Performance)
*   **SSD寿命の最適化**: SQLiteの処理をメモリ上で完結させる（Journal Mode: MEMORY / Temp Store: MEMORY 等）ことで、ディスクへの書き込みを劇的に削減。大切なPCのストレージ寿命を保護しながら、高速なレスポンスを実現します。
*   **不整合の徹底排除**: 生成された各音声ファイルにはテキスト内容に基づくハッシュが付与されます。内容を書き換えると古いファイルは自動的に破棄され、常に「最新のテキスト」と「音声」が一致する状態を保ちます。

## 環境構築・セットアップ

本アプリの利用には、FFmpeg (Whisper対応版)、VOICEVOX、および学習済みモデルの準備が必要です。

詳細なセットアップ手順（GitHubからの入手方法、OS別の環境構築、各種ツールの配置方法など）については、以下のガイドを参照してください。

> [!IMPORTANT]
> **[セットアップガイド (docs/setup.md)](docs/setup.md)**
> 初心者の方でも迷わずに進められるよう、画像プレースホルダー付きで丁寧に解説しています。

### 必須コンポーネントの概要

セットアップガイドでは以下のツールの導入手順を解説しています：

*   **Python (uv)**: パッケージ管理ツール `uv` を使用して、安定した実行環境を構築します。
*   **FFmpeg (Whisper フィルター内蔵)**: 音声認識のコアとなるコンポーネントです。
*   **VOICEVOX**: 音声合成エンジンです（インストーラー版推奨）。
*   **Whisper / VAD モデル**: 低スペックから高精度まで、PC環境に合わせたモデル選択が可能です。

---



## 使い方

1.  **設定の確認**
    管理画面の各セクション（FFmpeg Configuration, Resolve Configuration等）を展開し、各種パスやデバイス設定が正しいことを確認してください。
    > [!IMPORTANT]
    > STARTボタンを有効にするには、以下の条件を満たしている必要があります。
    > 1. **VOICEVOXの起動**: VOICEVOXが起動しており、画面上部の **[VOICEVOX CONNECTED]** インジケータが点灯していること。
    > 2. **出力ディレクトリの設定**: `Output Directory` が正しく設定されていること。
    > 3. **FFmpegパスの設定**: `FFmpeg Configuration` で正しいパスが指定されていること。

2.  **文字起こしの開始**
    画面右上の **[START]** ボタンを押すと、FFmpegが起動し、マイク入力のリアルタイム文字起こしが開始されます。

3.  **音声合成と連携**
    *   **自動生成**: `Synthesis Timing` が `Immediate` に設定されている場合、文字起こし確定と同時にVOICEVOXによる音声合成が実行されます。
    *   **素材の挿入**: ログに表示された各アイテムの「挿入」ボタンを押すことで、DaVinci Resolveのタイムラインへ音声と字幕が配置されます。

4.  **修正と再実行**
    文字起こしに誤りがある場合は、UI上でテキストを直接編集できます。編集後に再生成ボタンを押すことで、修正後のテキストで音声を即座に作り直すことが可能です。
    > [!NOTE]
    > テキストの編集および音声の再生成は、システムが **STOP（停止）** 状態の時のみ可能です。START（動作中）は編集がロックされます。

## プロジェクト構成

*   `voicevox_controller.py`: アプリケーションのエントリーポイント。
*   `app/`: コアロジック、API、Web UI のソースコード。
*   `static/` / `templates/`: フロントエンド資産。
*   `config.json`: ユーザー設定。
*   `data/`: 生成された音声ファイルや履歴データベース（SQLite）。
*   `docs/specification/`: 詳細な仕様ドキュメント。

詳細については、`docs/` フォルダ内の仕様書を参照してください。
